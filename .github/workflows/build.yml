# .github/workflows/build-no-git.yml
name: ESP32-C3 No-Git Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container: espressif/idf:v5.4.2
    
    steps:
    # 1. ì½”ë“œ ë‹¤ìš´ë¡œë“œ
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    # 2. ESP-Matter ì»´í¬ë„ŒíŠ¸ë¥¼ ZIPìœ¼ë¡œ ì§ì ‘ ë‹¤ìš´ë¡œë“œ
    - name: ESP-Matter ì»´í¬ë„ŒíŠ¸ ë‹¤ìš´ë¡œë“œ
      run: |
        # ìž‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p /opt/esp-matter-components
        cd /opt/esp-matter-components
        
        # ESP-Matter ë©”ì¸ íŒŒì¼ë“¤ ë‹¤ìš´ë¡œë“œ (ZIP)
        echo "ðŸ“¦ ESP-Matter ë©”ì¸ ì»´í¬ë„ŒíŠ¸ ë‹¤ìš´ë¡œë“œ ì¤‘..."
        wget -q --no-check-certificate https://github.com/espressif/esp-matter/archive/refs/heads/main.zip -O esp-matter.zip
        unzip -q esp-matter.zip
        mv esp-matter-main esp-matter
        rm esp-matter.zip
        
        # ConnectedHomeIP ì»´í¬ë„ŒíŠ¸ ë‹¤ìš´ë¡œë“œ (í•µì‹¬ ë¶€ë¶„ë§Œ)
        echo "ðŸ“¦ ConnectedHomeIP ì»´í¬ë„ŒíŠ¸ ë‹¤ìš´ë¡œë“œ ì¤‘..."
        mkdir -p esp-matter/connectedhomeip
        cd esp-matter/connectedhomeip
        wget -q --no-check-certificate https://github.com/project-chip/connectedhomeip/archive/refs/heads/master.zip -O chip.zip
        unzip -q chip.zip
        mv connectedhomeip-master connectedhomeip
        rm chip.zip
        
        # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        echo "ESP_MATTER_PATH=/opt/esp-matter-components/esp-matter" >> $GITHUB_ENV
        echo "MATTER_SDK_PATH=/opt/esp-matter-components/esp-matter/connectedhomeip/connectedhomeip" >> $GITHUB_ENV

    # 3. í•„ìš”í•œ íŒ¨í‚¤ì§€ë§Œ ì„¤ì¹˜
    - name: í•„ìš”í•œ ë„êµ¬ ì„¤ì¹˜
      run: |
        apt-get update -qq
        apt-get install -y -qq python3-pip

    # 4. í”„ë¡œì íŠ¸ ë¹Œë“œ
    - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
      run: |
        # ESP-IDF í™˜ê²½ í™œì„±í™”
        . $IDF_PATH/export.sh
        
        # í™˜ê²½ë³€ìˆ˜ ìž¬í™•ì¸
        export ESP_MATTER_PATH=/opt/esp-matter-components/esp-matter
        export MATTER_SDK_PATH=/opt/esp-matter-components/esp-matter/connectedhomeip/connectedhomeip
        
        echo "âœ… ESP_MATTER_PATH: $ESP_MATTER_PATH"
        echo "âœ… MATTER_SDK_PATH: $MATTER_SDK_PATH" 
        echo "âœ… IDF_PATH: $IDF_PATH"
        
        # ë¹Œë“œ ì‹¤í–‰
        idf.py set-target esp32c3
        idf.py build

    # 5. ë°”ì´ë„ˆë¦¬ ì—…ë¡œë“œ
    - name: ë°”ì´ë„ˆë¦¬ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: esp32c3-no-git-${{ github.run_number }}
        path: |
          build/*.bin
          build/*.elf
          build/bootloader/bootloader.bin
          build/partition_table/partition-table.bin
        retention-days: 30

    # 6. í”Œëž˜ì‹œ ê°€ì´ë“œ ìƒì„±
    - name: í”Œëž˜ì‹œ ê°€ì´ë“œ ìƒì„±
      run: |
        cat > flash_guide.txt << 'EOF'
        # ESP32-C3 í”Œëž˜ì‹œ ê°€ì´ë“œ
        
        ## 1. í•„ìš”í•œ íŒŒì¼ë“¤
        - ESP32C3_MATTER_BME680.bin (ë©”ì¸ íŽŒì›¨ì–´)
        - bootloader.bin (ë¶€íŠ¸ë¡œë”)
        - partition-table.bin (íŒŒí‹°ì…˜ í…Œì´ë¸”)
        
        ## 2. í”Œëž˜ì‹œ ëª…ë ¹ì–´
        
        ### Linux/macOS:
        esptool.py --chip esp32c3 --port /dev/ttyUSB0 --baud 460800 write_flash \
          0x0 bootloader.bin \
          0x8000 partition-table.bin \
          0x10000 ESP32C3_MATTER_BME680.bin
        
        ### Windows:
        esptool.py --chip esp32c3 --port COM3 --baud 460800 write_flash \
          0x0 bootloader.bin \
          0x8000 partition-table.bin \
          0x10000 ESP32C3_MATTER_BME680.bin
        
        ## 3. í¬íŠ¸ ì°¾ê¸°
        - Linux: /dev/ttyUSB0, /dev/ttyACM0
        - Windows: COM3, COM4, COM5 ë“± (ìž¥ì¹˜ê´€ë¦¬ìžì—ì„œ í™•ì¸)
        - macOS: /dev/cu.usbserial-* 
        
        ## 4. esptool ì„¤ì¹˜
        pip install esptool
        
        ## 5. ëª¨ë‹ˆí„°ë§
        esptool.py --chip esp32c3 --port [í¬íŠ¸] monitor
        EOF

    - name: í”Œëž˜ì‹œ ê°€ì´ë“œ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: flash-guide-${{ github.run_number }}
        path: flash_guide.txt
        retention-days: 30

    # 7. ë¹Œë“œ ê²°ê³¼ í™•ì¸
    - name: ë¹Œë“œ ê²°ê³¼
      run: |
        echo "ðŸŽ‰ Git ì—†ëŠ” ë¹Œë“œ ì„±ê³µ!"
        echo "ðŸ“ ìƒì„±ëœ íŒŒì¼ë“¤:"
        find build -name "*.bin" -o -name "*.elf" | head -5
        echo ""
        echo "ðŸ“¦ ë‹¤ìš´ë¡œë“œ ë°©ë²•:"
        echo "  1. GitHub â†’ Actions â†’ ì´ ë¹Œë“œ í´ë¦­"
        echo "  2. Artifacts ì„¹ì…˜ì—ì„œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ"
        echo "  3. ì••ì¶• í•´ì œ í›„ ESP32-C3ì— í”Œëž˜ì‹œ"