# .github/workflows/build-matter-complete.yml
name: ESP32-C3 Complete Matter Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container: espressif/idf:v5.4.2
    
    steps:
    # 1. ì½”ë“œ ë‹¤ìš´ë¡œë“œ
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # 2. Git ë° í•„ìš”í•œ ë„êµ¬ ì„¤ì¹˜
    - name: í•„ìš”í•œ ë„êµ¬ ì„¤ì¹˜
      run: |
        apt-get update -qq
        apt-get install -y -qq git curl wget unzip python3-pip build-essential

    # 3. ESP-Matter ì™„ì „ ì„¤ì¹˜ (git submodule í¬í•¨)
    - name: ESP-Matter ì™„ì „ ì„¤ì¹˜
      run: |
        echo "ğŸ“¦ ESP-Matter ì™„ì „ ì„¤ì¹˜ ì‹œì‘..."
        
        # ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p /opt/esp-matter
        cd /opt/esp-matter
        
        # Git ì„¤ì • (submoduleì„ ìœ„í•´ í•„ìš”)
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        git config --global init.defaultBranch main
        
        # ESP-Matter í´ë¡  (recursive submodules í¬í•¨)
        echo "ğŸ“¥ ESP-Matter ë©”ì¸ ì €ì¥ì†Œ í´ë¡  ì¤‘..."
        git clone --recursive --depth 1 --jobs 8 https://github.com/espressif/esp-matter.git .
        
        # í•„ìˆ˜ ì„œë¸Œëª¨ë“ˆë“¤ì´ ì œëŒ€ë¡œ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
        echo "ğŸ” í•„ìˆ˜ ì»´í¬ë„ŒíŠ¸ í™•ì¸ ì¤‘..."
        if [ ! -d "connectedhomeip/connectedhomeip" ]; then
          echo "ConnectedHomeIP ì„œë¸Œëª¨ë“ˆ ìˆ˜ë™ ì´ˆê¸°í™”..."
          git submodule update --init --recursive connectedhomeip
        fi
        
        # í•„ìˆ˜ ë””ë ‰í† ë¦¬ë“¤ í™•ì¸
        required_dirs=(
          "connectedhomeip/connectedhomeip/config/esp32/components"
          "examples/common"
          "components"
        )
        
        for dir in "${required_dirs[@]}"; do
          if [ ! -d "$dir" ]; then
            echo "âŒ í•„ìˆ˜ ë””ë ‰í† ë¦¬ ëˆ„ë½: $dir"
            exit 1
          else
            echo "âœ… í™•ì¸ë¨: $dir"
          fi
        done
        
        # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        echo "ESP_MATTER_PATH=/opt/esp-matter" >> $GITHUB_ENV
        echo "MATTER_SDK_PATH=/opt/esp-matter/connectedhomeip/connectedhomeip" >> $GITHUB_ENV

    # 4. ESP-Matter ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ESP-Matter ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        echo "âš™ï¸ ESP-Matter ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
        cd /opt/esp-matter
        
        # ESP-IDF í™˜ê²½ ë¨¼ì € í™œì„±í™”
        . $IDF_PATH/export.sh
        
        # ESP-Matter ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        ./install.sh
        
        # ESP-Matter í™˜ê²½ í™œì„±í™”
        . ./export.sh
        
        echo "âœ… ESP-Matter ì„¤ì¹˜ ì™„ë£Œ"

    # 5. í”„ë¡œì íŠ¸ ë¹Œë“œ í™˜ê²½ í™•ì¸
    - name: ë¹Œë“œ í™˜ê²½ í™•ì¸
      run: |
        echo "ğŸ” ë¹Œë“œ í™˜ê²½ í™•ì¸ ì¤‘..."
        
        # í™˜ê²½ë³€ìˆ˜ í™•ì¸
        echo "ESP_MATTER_PATH: $ESP_MATTER_PATH"
        echo "MATTER_SDK_PATH: $MATTER_SDK_PATH"
        echo "IDF_PATH: $IDF_PATH"
        
        # í•„ìˆ˜ ë””ë ‰í† ë¦¬ë“¤ ì¡´ì¬ í™•ì¸
        ls -la $ESP_MATTER_PATH/
        ls -la $ESP_MATTER_PATH/connectedhomeip/connectedhomeip/config/esp32/components/ || echo "ESP32 ì»´í¬ë„ŒíŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸ í•„ìš”"
        
        # CMakeLists.txt í™•ì¸
        echo "ğŸ“‹ CMakeLists.txt ë‚´ìš©:"
        head -20 CMakeLists.txt

    # 6. í”„ë¡œì íŠ¸ ë¹Œë“œ
    - name: Matter í”„ë¡œì íŠ¸ ë¹Œë“œ
      run: |
        echo "ğŸ—ï¸ ESP32-C3 Matter ì„¼ì„œ ë¹Œë“œ ì¤‘..."
        
        # í™˜ê²½ ì¬ì„¤ì •
        . $IDF_PATH/export.sh
        . $ESP_MATTER_PATH/export.sh
        
        # í™˜ê²½ë³€ìˆ˜ ì¬í™•ì¸
        export ESP_MATTER_PATH=/opt/esp-matter
        export MATTER_SDK_PATH=/opt/esp-matter/connectedhomeip/connectedhomeip
        
        echo "ë¹Œë“œ í™˜ê²½:"
        echo "  ESP_MATTER_PATH=$ESP_MATTER_PATH"
        echo "  MATTER_SDK_PATH=$MATTER_SDK_PATH"
        echo "  IDF_PATH=$IDF_PATH"
        
        # íƒ€ê²Ÿ ì„¤ì • ë° ë¹Œë“œ
        idf.py set-target esp32c3
        idf.py build
        
        echo "âœ… Matter ë¹Œë“œ ì™„ë£Œ!"

    # 7. ë¹Œë“œ ê²°ê³¼ í™•ì¸
    - name: ë¹Œë“œ ê²°ê³¼ í™•ì¸
      run: |
        echo "ğŸ“Š ë¹Œë“œ ê²°ê³¼ í™•ì¸:"
        
        # ìƒì„±ëœ íŒŒì¼ë“¤ í™•ì¸
        if [ -f "build/ESP32C3_MATTER_BME680.bin" ]; then
          echo "âœ… ë©”ì¸ íŒì›¨ì–´: $(stat -c%s build/ESP32C3_MATTER_BME680.bin) bytes"
        else
          echo "âŒ ë©”ì¸ íŒì›¨ì–´ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          ls -la build/*.bin || echo "bin íŒŒì¼ ì—†ìŒ"
        fi
        
        if [ -f "build/bootloader/bootloader.bin" ]; then
          echo "âœ… ë¶€íŠ¸ë¡œë”: $(stat -c%s build/bootloader/bootloader.bin) bytes"
        fi
        
        if [ -f "build/partition_table/partition-table.bin" ]; then
          echo "âœ… íŒŒí‹°ì…˜ í…Œì´ë¸”: $(stat -c%s build/partition_table/partition-table.bin) bytes"
        fi
        
        # ì „ì²´ í”Œë˜ì‹œ í¬ê¸° ê³„ì‚°
        total_size=0
        for file in build/*.bin build/bootloader/*.bin build/partition_table/*.bin; do
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file")
            total_size=$((total_size + size))
          fi
        done
        echo "ğŸ“ ì´ íŒì›¨ì–´ í¬ê¸°: $total_size bytes"

    # 8. Matter ë°”ì´ë„ˆë¦¬ ì—…ë¡œë“œ
    - name: Matter ë°”ì´ë„ˆë¦¬ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: esp32c3-matter-complete-${{ github.run_number }}
        path: |
          build/*.bin
          build/*.elf
          build/*.map
          build/bootloader/bootloader.bin
          build/partition_table/partition-table.bin
        retention-days: 30

    # 9. Matter í”Œë˜ì‹œ ê°€ì´ë“œ ìƒì„±
    - name: Matter í”Œë˜ì‹œ ê°€ì´ë“œ ìƒì„±
      run: |
        cat > matter_flash_guide.txt << 'EOF'
        # ESP32-C3 Matter ì„¼ì„œ í”Œë˜ì‹œ ê°€ì´ë“œ
        
        ## ğŸ¯ Matter ì„¼ì„œ ê¸°ëŠ¥
        - ì˜¨ë„/ìŠµë„ ì„¼ì„œ (SHTC3) - I2C
        - ì›€ì§ì„ ê°ì§€ ì„¼ì„œ (PIR) - GPIO
        - Matter 1.4 í˜¸í™˜
        - WiFi ì—°ê²° ì§€ì›
        - OTA ì—…ë°ì´íŠ¸ ì§€ì›
        
        ## ğŸ”Œ í•˜ë“œì›¨ì–´ ì—°ê²°
        
        ### SHTC3 ì„¼ì„œ (I2C):
        | ESP32-C3 Pin | SHTC3 Pin |
        |--------------|-----------|
        | GPIO 4       | SDA       |
        | GPIO 5       | SCL       |
        | 3V3          | VCC       |
        | GND          | GND       |
        
        ### PIR ì„¼ì„œ:
        | ESP32-C3 Pin | PIR Pin |
        |--------------|---------|
        | GPIO 7       | Signal  |
        | 3V3          | VCC     |
        | GND          | GND     |
        
        ## ğŸ“± íŒì›¨ì–´ í”Œë˜ì‹œ
        
        ### 1. esptool ì„¤ì¹˜
        ```bash
        pip install esptool
        ```
        
        ### 2. íŒì›¨ì–´ í”Œë˜ì‹œ
        ```bash
        # Linux/macOS
        esptool.py --chip esp32c3 --port /dev/ttyUSB0 --baud 460800 write_flash \
          0x0 bootloader.bin \
          0xc000 partition-table.bin \
          0x20000 ESP32C3_MATTER_BME680.bin
        
        # Windows  
        esptool.py --chip esp32c3 --port COM3 --baud 460800 write_flash \
          0x0 bootloader.bin \
          0xc000 partition-table.bin \
          0x20000 ESP32C3_MATTER_BME680.bin
        ```
        
        ### 3. ì‹œë¦¬ì–¼ ëª¨ë‹ˆí„°
        ```bash
        esptool.py --chip esp32c3 --port [í¬íŠ¸] monitor
        ```
        
        ## ğŸŒ Matter ì„¤ì •
        
        ### 1. WiFi ì—°ê²° ëŒ€ê¸°
        ì‹œë¦¬ì–¼ ëª¨ë‹ˆí„°ì—ì„œ WiFi ì„¤ì • ë©”ì‹œì§€ í™•ì¸
        
        ### 2. Matter ì»¤ë¯¸ì…”ë‹
        ```bash
        # chip-tool ì‚¬ìš© ì˜ˆì‹œ
        chip-tool pairing ble-wifi 1 "WIFI_SSID" "WIFI_PASSWORD" 20202021 3840
        ```
        
        ### 3. ì„¼ì„œ ë°ì´í„° ì½ê¸°
        ```bash
        # ì˜¨ë„ ì„¼ì„œ (ì—”ë“œí¬ì¸íŠ¸ 1)
        chip-tool temperaturemeasurement read measured-value 1 1
        
        # ìŠµë„ ì„¼ì„œ (ì—”ë“œí¬ì¸íŠ¸ 2)
        chip-tool relativehumiditymeasurement read measured-value 1 2
        
        # ì›€ì§ì„ ì„¼ì„œ (ì—”ë“œí¬ì¸íŠ¸ 3)
        chip-tool occupancysensing read occupancy 1 3
        ```
        
        ### 4. ì†ì„± êµ¬ë… (ìë™ ì—…ë°ì´íŠ¸)
        ```bash
        # ì˜¨ë„ ë³€í™” êµ¬ë… (3ì´ˆë§ˆë‹¤, ìµœëŒ€ 10ë¶„)
        chip-tool temperaturemeasurement subscribe measured-value 3 600 1 1
        
        # ìŠµë„ ë³€í™” êµ¬ë…
        chip-tool relativehumiditymeasurement subscribe measured-value 3 600 1 2
        
        # ì›€ì§ì„ ê°ì§€ êµ¬ë…
        chip-tool occupancysensing subscribe occupancy 3 600 1 3
        ```
        
        ## ğŸ”§ ë¬¸ì œ í•´ê²°
        
        ### WiFi ì—°ê²° ì•ˆë¨
        - ì‹œë¦¬ì–¼ ëª¨ë‹ˆí„°ì—ì„œ WiFi ìƒíƒœ í™•ì¸
        - 2.4GHz WiFi ì‚¬ìš© (5GHz ë¶ˆê°€)
        - SSID/ë¹„ë°€ë²ˆí˜¸ ì •í™•ì„± í™•ì¸
        
        ### Matter í˜ì–´ë§ ì‹¤íŒ¨
        - ì…‹ì—… ì½”ë“œ: 20202021
        - Discriminator: 3840
        - íŒ©í† ë¦¬ ë¦¬ì…‹: ë¦¬ì…‹ ë²„íŠ¼ 5ì´ˆ ì´ìƒ ëˆ„ë¥´ê¸°
        
        ### ì„¼ì„œ ë°ì´í„° ì•ˆë‚˜ì˜´
        - í•˜ë“œì›¨ì–´ ì—°ê²° ì¬í™•ì¸
        - I2C í’€ì—… ì €í•­ (4.7kÎ©) í™•ì¸
        - ì „ì› ê³µê¸‰ ìƒíƒœ í™•ì¸
        
        ## ğŸ“Š ê¸°ëŒ€ ê²°ê³¼
        
        ì •ìƒ ë™ì‘ì‹œ ì‹œë¦¬ì–¼ ëª¨ë‹ˆí„° ì¶œë ¥:
        ```
        I (1234) app_main: Matter sensor started
        I (2345) app_main: WiFi connected
        I (3456) app_main: Matter commissioning window opened
        I (4567) app_main: Temperature: 25.6Â°C
        I (5678) app_main: Humidity: 45.2%
        I (6789) app_main: Motion detected: true
        ```
        
        Matter ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì„¼ì„œ ê°’ í™•ì¸ ê°€ëŠ¥
        EOF

    - name: Matter ê°€ì´ë“œ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: matter-guide-${{ github.run_number }}
        path: matter_flash_guide.txt
        retention-days: 30

    # 10. ìµœì¢… ê²°ê³¼
    - name: Matter ë¹Œë“œ ì™„ë£Œ
      run: |
        echo "ğŸ‰ ESP32-C3 Matter ì„¼ì„œ ë¹Œë“œ ì™„ë£Œ!"
        echo ""
        echo "ğŸ“¦ ì œê³µë˜ëŠ” ê¸°ëŠ¥:"
        echo "  âœ… Matter 1.4 í˜¸í™˜ ì„¼ì„œ"
        echo "  âœ… ì˜¨ë„/ìŠµë„ ì¸¡ì • (SHTC3)"
        echo "  âœ… ì›€ì§ì„ ê°ì§€ (PIR)"
        echo "  âœ… WiFi ì—°ê²°"
        echo "  âœ… OTA ì—…ë°ì´íŠ¸"
        echo ""
        echo "ğŸ“ ë‹¤ìš´ë¡œë“œ íŒŒì¼:"
        echo "  â€¢ esp32c3-matter-complete-${{ github.run_number }}: íŒì›¨ì–´ íŒŒì¼ë“¤"
        echo "  â€¢ matter-guide-${{ github.run_number }}: ìƒì„¸ ì‚¬ìš©ë²•"
        echo ""
        echo "ğŸš€ ë‹¤ìŒ ë‹¨ê³„:"
        echo "  1. Artifactsì—ì„œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ"
        echo "  2. í•˜ë“œì›¨ì–´ ì—°ê²° (ê°€ì´ë“œ ì°¸ì¡°)"
        echo "  3. íŒì›¨ì–´ í”Œë˜ì‹œ"
        echo "  4. Matter ì»¨íŠ¸ë¡¤ëŸ¬ë¡œ í˜ì–´ë§"
        echo "  5. ì„¼ì„œ ë°ì´í„° í™•ì¸"