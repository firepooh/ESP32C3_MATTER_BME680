# .github/workflows/build-ultra-fast.yml
name: ESP32-C3 Ultra Fast Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container: espressif/idf:v5.4.2  # ì´ë¯¸ ESP-IDFê°€ ì„¤ì¹˜ëœ ì»¨í…Œì´ë„ˆ ì‚¬ìš©
    
    steps:
    # 1. ì½”ë“œ ë‹¤ìš´ë¡œë“œ
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    # 2. Matter ì»´í¬ë„ŒíŠ¸ë§Œ ë‹¤ìš´ë¡œë“œ (ì „ì²´ í´ë¡  ì—†ì´)
    - name: Matter ì»´í¬ë„ŒíŠ¸ ë‹¤ìš´ë¡œë“œ
      run: |
        # í•„ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p /opt/esp-matter
        cd /opt/esp-matter
        
        # GitHub APIë¡œ í•„ìš”í•œ íŒŒì¼ë“¤ë§Œ ë‹¤ìš´ë¡œë“œ (zip íŒŒì¼)
        wget -q https://github.com/espressif/esp-matter/archive/refs/heads/main.zip
        unzip -q main.zip
        mv esp-matter-main/* .
        rm -rf esp-matter-main main.zip
        
        # í•„ìˆ˜ ì»´í¬ë„ŒíŠ¸ë§Œ ì´ˆê¸°í™”
        git submodule update --init --depth 1 --jobs 4 \
          connectedhomeip/connectedhomeip/config/esp32 \
          connectedhomeip/connectedhomeip/src/platform/ESP32
        
        echo "ESP_MATTER_PATH=/opt/esp-matter" >> $GITHUB_ENV

    # 3. ë¹Œë“œ (í™˜ê²½ë³€ìˆ˜ ì§ì ‘ ì„¤ì •)
    - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
      run: |
        # í™˜ê²½ë³€ìˆ˜ ì§ì ‘ ì„¤ì • (export.sh ì‹¤í–‰ ì—†ì´)
        export ESP_MATTER_PATH=/opt/esp-matter
        export MATTER_SDK_PATH=/opt/esp-matter/connectedhomeip/connectedhomeip
        
        # ESP-IDF í™˜ê²½ë§Œ í™œì„±í™”
        . $IDF_PATH/export.sh
        
        # ë¹Œë“œ
        idf.py set-target esp32c3
        idf.py build

    # 4. ë°”ì´ë„ˆë¦¬ ì—…ë¡œë“œ
    - name: ë°”ì´ë„ˆë¦¬ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: esp32c3-ultra-fast-${{ github.run_number }}
        path: |
          build/*.bin
          build/*.elf
          build/bootloader/bootloader.bin
          build/partition_table/partition-table.bin

    # 5. ì™„ë£Œ ë©”ì‹œì§€
    - name: ë¹Œë“œ ì™„ë£Œ
      run: |
        echo "ğŸš€ ì´ˆê³ ì† ë¹Œë“œ ì™„ë£Œ!"
        echo "ğŸ“ˆ ì˜ˆìƒ ì‹œê°„ ë‹¨ì¶•: 70-80%"
        ls -la build/*.bin

---
# ì¶”ê°€: ìºì‹œë¥¼ í™œìš©í•œ ìŠ¤ë§ˆíŠ¸ ë¹Œë“œ
# .github/workflows/build-smart.yml
name: ESP32-C3 Smart Build (with Cache)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    # ESP-IDF + ESP-Matter í†µí•© ìºì‹œ
    - name: ESP ê°œë°œí™˜ê²½ ìºì‹œ
      uses: actions/cache@v4
      id: esp-cache
      with:
        path: |
          ~/esp-idf
          ~/esp-matter-minimal
        key: esp-dev-v5.4.2-matter-minimal-${{ hashFiles('**/CMakeLists.txt', '**/sdkconfig.defaults') }}
        restore-keys: |
          esp-dev-v5.4.2-matter-minimal-

    # ìºì‹œ ë¯¸ìŠ¤ì¼ ë•Œë§Œ ì„¤ì¹˜
    - name: ESP ê°œë°œí™˜ê²½ ì„¤ì¹˜ (ìºì‹œ ë¯¸ìŠ¤ì‹œ)
      if: steps.esp-cache.outputs.cache-hit != 'true'
      run: |
        # ESP-IDF ì„¤ì¹˜
        mkdir -p ~/esp-idf
        cd ~/esp-idf
        git clone --branch v5.4.2 --depth 1 https://github.com/espressif/esp-idf.git .
        ./install.sh esp32c3
        
        # ESP-Matter ìµœì†Œ ì„¤ì¹˜
        mkdir -p ~/esp-matter-minimal
        cd ~/esp-matter-minimal
        
        # í•µì‹¬ íŒŒì¼ë“¤ë§Œ ë‹¤ìš´ë¡œë“œ
        wget -q https://api.github.com/repos/espressif/esp-matter/tarball/main -O matter.tar.gz
        tar -xzf matter.tar.gz --strip-components=1
        rm matter.tar.gz
        
        # ESP32 ê´€ë ¨ ì„œë¸Œëª¨ë“ˆë§Œ
        git submodule update --init --depth 1 --recursive \
          connectedhomeip/connectedhomeip/config/esp32/components

    # ë¹Œë“œ í™˜ê²½ ì„¤ì •
    - name: í™˜ê²½ ì„¤ì •
      run: |
        echo "IDF_PATH=~/esp-idf" >> $GITHUB_ENV
        echo "ESP_MATTER_PATH=~/esp-matter-minimal" >> $GITHUB_ENV

    # ë¹Œë“œ
    - name: ë¹Œë“œ
      run: |
        source $IDF_PATH/export.sh
        idf.py set-target esp32c3
        idf.py build

    # ê²°ê³¼ ì—…ë¡œë“œ
    - name: ë°”ì´ë„ˆë¦¬ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: esp32c3-smart-${{ github.run_number }}
        path: build/*.bin
